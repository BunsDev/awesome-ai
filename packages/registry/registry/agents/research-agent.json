{
	"name": "research-agent",
	"type": "registry:agent",
	"title": "Research Agent",
	"description": "Research Agent - an AI agent",
	"dependencies": ["ai"],
	"registryDependencies": [
		"agents:lib/context",
		"agents:lib/environment",
		"prompts:research-agent",
		"tools:glob",
		"tools:grep",
		"tools:list",
		"tools:read",
		"tools:todo"
	],
	"files": [
		{
			"path": "agents/research-agent.ts",
			"type": "registry:agent",
			"content": "import { Experimental_Agent as Agent, type LanguageModel } from \"ai\"\nimport { summarizeMessages } from \"@/agents/lib/context\"\nimport {\n\ttype EnvironmentOptions,\n\tgetEnvironmentContext,\n} from \"@/agents/lib/environment\"\nimport { getSystemPrompt } from \"@/prompts/research-agent\"\nimport { globTool } from \"@/tools/glob\"\nimport { grepTool } from \"@/tools/grep\"\nimport { listTool } from \"@/tools/list\"\nimport { readTool } from \"@/tools/read\"\nimport { createTodoTools, type TodoStorage } from \"@/tools/todo\"\n\nexport interface AgentSettings {\n\tmodel: LanguageModel\n\tcwd?: string\n\tenvironment?: EnvironmentOptions\n\ttodoStorage?: TodoStorage\n}\n\nexport async function createAgent({\n\tmodel,\n\tcwd,\n\tenvironment,\n\ttodoStorage,\n}: AgentSettings) {\n\tconst env = await getEnvironmentContext({ cwd, ...environment })\n\tconst instructions = getSystemPrompt(env)\n\tconst { todoRead, todoWrite } = createTodoTools(todoStorage)\n\tconst tools = {\n\t\tread: readTool,\n\t\tlist: listTool,\n\t\tgrep: grepTool,\n\t\tglob: globTool,\n\t\ttodoRead,\n\t\ttodoWrite,\n\t}\n\n\tconst agent = new Agent({\n\t\tmodel,\n\t\tinstructions,\n\t\ttools,\n\t\tasync prepareStep({ steps, messages }) {\n\t\t\tconst threshold = 200_000\n\t\t\tconst lastStep = steps.at(-1)\n\t\t\tconst inputTokens = lastStep?.usage?.inputTokens\n\n\t\t\tif (!inputTokens || inputTokens < threshold) {\n\t\t\t\treturn {}\n\t\t\t}\n\n\t\t\tconst summarized = await summarizeMessages(messages, model, {\n\t\t\t\tthreshold,\n\t\t\t\tkeepRecent: 8,\n\t\t\t\tprotectTokens: 40_000,\n\t\t\t})\n\t\t\treturn summarized ? { messages: summarized } : {}\n\t\t},\n\t\tproviderOptions: {\n\t\t\topenai: {\n\t\t\t\treasoningEffort: \"medium\",\n\t\t\t\treasoningSummary: \"detailed\",\n\t\t\t},\n\t\t},\n\t\tstopWhen: ({ steps }) => {\n\t\t\tif (steps.length === 0) return false\n\n\t\t\tconst lastStep = steps[steps.length - 1]\n\t\t\tif (!lastStep) return false\n\n\t\t\tif (lastStep.toolCalls && lastStep.toolCalls.length > 0) {\n\t\t\t\treturn false\n\t\t\t}\n\n\t\t\treturn true\n\t\t},\n\t})\n\n\treturn agent\n}\n\n"
		}
	]
}
